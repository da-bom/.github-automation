# =============================================================================
# Jira Create Dispatch Handler
# =============================================================================
#
# 개요:
#   Jira Automation에서 SubTask가 생성되면 repository_dispatch 이벤트를 통해
#   이 워크플로우가 트리거된다. actions/create-github-app-token 액션으로
#   GitHub App 인증을 자동 처리하고, gh CLI로 대상 Repo에 Issue를 생성한다.
#
# 흐름:
#   Jira SubTask 생성
#     → Jira Automation이 repository_dispatch (event_type: create_issue) 호출
#     → payload에서 repoName, title, body, labels 추출
#     → actions/create-github-app-token이 JWT + Installation Token 자동 발급
#     → gh CLI로 대상 Repo에 Issue 생성
#
# -----------------------------------------------------------------------------
# Required Secrets (Settings → Secrets and variables → Actions):
# -----------------------------------------------------------------------------
#   APP_ID            - GitHub App ID (숫자, 예: 123456)
#   PRIVATE_KEY       - GitHub App Private Key 전체 내용 (-----BEGIN RSA PRIVATE KEY----- 포함)
#
# Required Variables (Settings → Secrets and variables → Actions → Variables):
#   ORG_NAME          - GitHub Organization 이름 (예: da-bom)
#
# Optional Secrets:
#   SLACK_WEBHOOK_URL - Slack Incoming Webhook URL (미설정 시 알림 스킵)
#
# -----------------------------------------------------------------------------
# Dispatch Payload (Jira Automation이 보내는 client_payload):
# -----------------------------------------------------------------------------
#   client_payload.repoName  - Issue를 생성할 대상 레포 이름 (예: web-core)
#   client_payload.issueKey  - Jira Issue Key (예: DABOM-42, 중복 체크에 사용)
#   client_payload.title     - GitHub Issue 제목 (예: [ABC-123] 로그인 오류 수정)
#   client_payload.body      - GitHub Issue 본문 (Markdown)
#   client_payload.labels    - GitHub Issue 라벨 배열 (예: ["feat", "backend"])
#   client_payload.assignee  - Jira 담당자 이름 (예: 홍길동, 미할당 시 빈 문자열)
# =============================================================================

name: Jira Create Dispatch Handler

on:
  repository_dispatch:
    types: [create_issue]

jobs:
  create-issue:
    runs-on: ubuntu-latest

    steps:
      - name: Generate GitHub App Token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.PRIVATE_KEY }}
          owner: ${{ vars.ORG_NAME }}

      - name: Check Duplicate Issue
        id: check-duplicate
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          REPO="${{ vars.ORG_NAME }}/${{ github.event.client_payload.repoName }}"
          ISSUE_KEY="${{ github.event.client_payload.issueKey }}"

          EXISTING=$(gh issue list --repo "$REPO" --search "[${ISSUE_KEY}]" --state all --json number,title \
            --jq ".[] | select(.title | startswith(\"[${ISSUE_KEY}]\")) | .number")

          if [ -n "$EXISTING" ]; then
            echo "::warning::Issue already exists for ${ISSUE_KEY}: #${EXISTING}"
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Ensure Labels Exist
        if: steps.check-duplicate.outputs.skip != 'true'
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
          ASSIGNEE: ${{ github.event.client_payload.assignee }}
        run: |
          REPO="${{ vars.ORG_NAME }}/${{ github.event.client_payload.repoName }}"
          for label in $(echo '${{ toJson(github.event.client_payload.labels) }}' | jq -r '.[]'); do
            gh label create "$label" --repo "$REPO" --force 2>/dev/null || true
          done

          # 담당자 라벨 생성 (이미 존재하면 스킵)
          if [ -n "$ASSIGNEE" ]; then
            if ! gh label list --repo "$REPO" --search "${ASSIGNEE}" --json name --jq '.[].name' | grep -qx "${ASSIGNEE}"; then
              gh label create "${ASSIGNEE}" --repo "$REPO" --color "1d76db" 2>/dev/null || true
            fi
          fi

      - name: Create GitHub Issue
        if: steps.check-duplicate.outputs.skip != 'true'
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
          ISSUE_BODY: ${{ github.event.client_payload.body }}
          ASSIGNEE: ${{ github.event.client_payload.assignee }}
        run: |
          REPO="${{ vars.ORG_NAME }}/${{ github.event.client_payload.repoName }}"
          TITLE="${{ github.event.client_payload.title }}"

          # 라벨 기반 브랜치 prefix (Feat → feat, Fix → fix 등)
          BRANCH_PREFIX=$(echo '${{ toJson(github.event.client_payload.labels) }}' | jq -r '.[0] // "feat"' | tr '[:upper:]' '[:lower:]')

          # Jira wiki markup → Markdown 변환 + 브랜치 prefix 치환
          echo "$ISSUE_BODY" > /tmp/issue_body.md
          sed -i \
            -e "s/__BRANCH_PREFIX__/${BRANCH_PREFIX}/g" \
            -e 's/^h1\. /# /g' \
            -e 's/^h2\. /## /g' \
            -e 's/^h3\. /### /g' \
            -e 's/^h4\. /#### /g' \
            -e 's/^h5\. /##### /g' \
            -e 's/^h6\. /###### /g' \
            -e 's/^\* \[/- [/g' \
            /tmp/issue_body.md

          LABEL_FLAGS=""
          for label in $(echo '${{ toJson(github.event.client_payload.labels) }}' | jq -r '.[]'); do
            LABEL_FLAGS="$LABEL_FLAGS --label $label"
          done

          # 담당자 라벨 추가
          if [ -n "$ASSIGNEE" ]; then
            LABEL_FLAGS="$LABEL_FLAGS --label ${ASSIGNEE}"
          fi

          ISSUE_URL=$(gh issue create \
            --repo "$REPO" \
            --title "$TITLE" \
            --body-file /tmp/issue_body.md \
            $LABEL_FLAGS)

          echo "::notice::Created issue: ${TITLE}"
          echo "::notice::URL: ${ISSUE_URL}"
          echo ""
          echo "========================================="
          echo "  Issue Created Successfully"
          echo "========================================="
          echo "  Title:    ${TITLE}"
          echo "  Repo:     ${REPO}"
          echo "  Assignee: ${ASSIGNEE:-없음}"
          echo "  URL:      ${ISSUE_URL}"
          echo "========================================="

      - name: Slack Failure Alert
        if: failure()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          if [ -n "$SLACK_WEBHOOK_URL" ]; then
            curl -s -X POST "$SLACK_WEBHOOK_URL" \
              -H "Content-Type: application/json" \
              -d '{"text": "Jira -> GitHub automation failed: run ${{ github.run_id }} / repo: ${{ github.event.client_payload.repoName }}"}'
          fi
