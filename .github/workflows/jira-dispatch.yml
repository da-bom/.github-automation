# =============================================================================
# Jira Dispatch Handler
# =============================================================================
#
# 개요:
#   Jira Automation에서 SubTask가 생성되면 repository_dispatch 이벤트를 통해
#   이 워크플로우가 트리거된다. actions/create-github-app-token 액션으로
#   GitHub App 인증을 자동 처리하고, gh CLI로 대상 Repo에 Issue를 생성한다.
#
# 흐름:
#   Jira SubTask 생성
#     → Jira Automation이 repository_dispatch (event_type: create_issue) 호출
#     → payload에서 repoName, title, body, labels 추출
#     → actions/create-github-app-token이 JWT + Installation Token 자동 발급
#     → gh CLI로 대상 Repo에 Issue 생성
#
# -----------------------------------------------------------------------------
# Required Secrets (Settings → Secrets and variables → Actions):
# -----------------------------------------------------------------------------
#   APP_ID            - GitHub App ID (숫자, 예: 123456)
#   PRIVATE_KEY       - GitHub App Private Key 전체 내용 (-----BEGIN RSA PRIVATE KEY----- 포함)
#
# Required Variables (Settings → Secrets and variables → Actions → Variables):
#   ORG_NAME          - GitHub Organization 이름 (예: da-bom)
#
# Optional Secrets:
#   SLACK_WEBHOOK_URL - Slack Incoming Webhook URL (미설정 시 알림 스킵)
#
# -----------------------------------------------------------------------------
# Dispatch Payload (Jira Automation이 보내는 client_payload):
# -----------------------------------------------------------------------------
#   client_payload.repoName  - Issue를 생성할 대상 레포 이름 (예: web-core)
#   client_payload.title     - GitHub Issue 제목 (예: [ABC-123] 로그인 오류 수정)
#   client_payload.body      - GitHub Issue 본문 (Markdown)
#   client_payload.labels    - GitHub Issue 라벨 배열 (예: ["feat", "backend"])
# =============================================================================

name: Jira Dispatch Handler

on:
  repository_dispatch:
    types: [create_issue]

jobs:
  create-issue:
    runs-on: ubuntu-latest

    steps:
      - name: Generate GitHub App Token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.PRIVATE_KEY }}
          owner: ${{ vars.ORG_NAME }}

      - name: Ensure Labels Exist
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          REPO="${{ vars.ORG_NAME }}/${{ github.event.client_payload.repoName }}"
          for label in $(echo '${{ toJson(github.event.client_payload.labels) }}' | jq -r '.[]'); do
            gh label create "$label" --repo "$REPO" --force 2>/dev/null || true
          done

      - name: Create GitHub Issue
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          REPO="${{ vars.ORG_NAME }}/${{ github.event.client_payload.repoName }}"
          TITLE="${{ github.event.client_payload.title }}"
          BODY="${{ github.event.client_payload.body }}"

          LABEL_FLAGS=""
          for label in $(echo '${{ toJson(github.event.client_payload.labels) }}' | jq -r '.[]'); do
            LABEL_FLAGS="$LABEL_FLAGS --label $label"
          done

          gh issue create \
            --repo "$REPO" \
            --title "$TITLE" \
            --body "$BODY" \
            $LABEL_FLAGS

      - name: Slack Failure Alert
        if: failure()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          if [ -n "$SLACK_WEBHOOK_URL" ]; then
            curl -s -X POST "$SLACK_WEBHOOK_URL" \
              -H "Content-Type: application/json" \
              -d '{"text": "Jira -> GitHub automation failed: run ${{ github.run_id }} / repo: ${{ github.event.client_payload.repoName }}"}'
          fi
